---
title: dockerå®‰è£…gogs\å¤‡ä»½\å­—ç¬¦é›†æŠ˜è…¾å¿ƒè·¯å†ç¨‹
tags: PM git docker 
author: O0lele0O
catalog: true
---



# å¼€å§‹

ç½‘ä¸Šéšä¾¿æŒ¡äº†ä¸ªdocker-compos.ymlï¼Œå¼€å¯äº†dockerä¹±æ•´æ¨¡å¼ã€‚åœ¨centos7.2æ— ç½‘æ¨¡å¼ä¸‹å„ç§ä¹±ä¸‹åŒ…æœåŠ¡å™¨å®‰è£…äº†dockerç¯å¢ƒï¼Œæ‹·è´äº†mysqlé•œåƒå’Œgogsé•œåƒï¼Œæèµ· docker-compose up -dã€‚

```yaml
version: '3.3'
services:
  gogsdb:
    image: mysql:latest
    container_name: gogsdb
#1#    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --init-connect='SET NAMES utf8mb4;' --innodb-flush-log-at-trx-commit=0
    restart: always
    environment:
      MYSQL_DATABASE: gogs
      MYSQL_ROOT_PASSWORD: gogs
      MYSQL_USER: gogs
      MYSQL_PASSWORD: gogs
    volumes:
      - db_data:/var/lib/mysql_gogs
#2#      - /Users/lele/docker_project/mysql/conf.d:/etc/mysql/conf.d
    ports:
      - "13306:3306"
    networks:
      - gogs-network

  gogsapp:
    depends_on:
      - gogsdb
    image: gogs/gogs
    container_name: gogsapp
    restart: always
    ports:
      - "322:22"
      - "3000:3000"
    volumes:
      - app_data:/data
      - /Users/lele/Downloads:/tmp
    networks:
      - gogs-network
volumes:
  db_data:
  app_data:
networks:
  gogs-network:
    driver: bridge
```



- å¼€å§‹æ²¡æœ‰è€ƒè™‘mysqlé…ç½®å’Œvolumeçš„æ¨¡å¼  æ²¡æœ‰ç”¨é‚£ä¸¤ä¸ª***#***æ³¨é‡Šé…ç½®é¡¹ï¼Œä»æ­¤ä¸ºä½¿ç”¨bugåŸ‹ä¸‹äº†ä¼ç¬”ã€‚

***é¢˜å¤–***ï¼šæœåŠ¡å™¨ä¸Šé¢ç¨³å®šçš„è·‘äº†å‡ ä¸ªæœˆï¼Œæš—æš—å¤¸èµç¨³å®šæ€§ä¸é”™

---

# é—®é¢˜

## Q1 å®‰è£…é¡µé¢è¦æ±‚è¾“å…¥mysqlé…ç½®åœ°å€ 



![gogs_install](/img/gogs_install.jpg)

  <!-- å› ä¸ºæ˜¯dockerç¯å¢ƒï¼ŒæŒ‰ç…§é…ç½®gogsappæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œgogsdbæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé€‰æ‹© 1 è¦ä¸å¡«ä¸»æœºIP+port 2 è¦ä¸å¡«gogsdbå®¹å™¨IP+port -->  

## A1ï¼šä½¿ç”¨dockerè‡ªå¸¦DNSåŠŸèƒ½  

1. gogsappæ€ä¹ˆè®¿é—®ä¸»æœºIPï¼Ÿå¯ä»¥æŸ¥çœ‹ä¸»æœºdockerå†…éƒ¨ç½‘ç»œIPè¾“å…¥ï¼Œä½†æ˜¯å¯åŠ¨å…³é—­å®¹å™¨éƒ½å¯èƒ½å¯¼è‡´ipå˜åŒ–ï¼Œä¸é è°±æ”¾å¼ƒã€‚
2. å­¦ä¹ dockerç½‘ç»œï¼Œå‘ç°dockerè‡ªå¸¦DNSåŠŸèƒ½å‘½å ä»gogsappå®¹å™¨ping gogsdbå®Œç¾é€šç•…ï¼Œé‚£å°±å¡«gogsdb:3306ã€‚

![gogs_pingdb](/img/gogs_pingdb.png)

â€‹        

- å¸¦æ¥ç–‘æƒ‘ï¼Œå¦‚æœéœ€è¦é…ç½®ä¸»æœºipï¼Œæ¯”å¦‚é‚®ç®±æœåŠ¡ï¼Œæœ‰æ²¡æœ‰ä¸»æœºåå¯ç”¨ï¼Ÿè¿™ä¸ªä¼¼ä¹å°±æ˜¯dockerç½‘ç»œç®¡ç†çš„ä¸œä¸œäº†ï¼Œk8sæ´¾ä¸Šç”¨åœºï¼Ÿæ‰“é€šå„ç§å®¹å™¨ç½‘ç»œå…¨éƒ¨é›†åˆä¹‹ï¼ŸãŠ™ï¸

## Q2ï¼š å¤´åƒæ˜¾ç¤ºå¤±è´¥

## A2ï¼šè¿™ä¸ªå¾—ç„ä»£ç  ç›®å‰æ›´æ–°ä¸‹å¤´åƒå¯ä»¥è§£å†³ 



## Q3ï¼šå»ºä»“åº“æ·»åŠ æ±‰å­—æè¿° 500é”™è¯¯

![gogs_500bug](/img/gogs_500bug.png)

## A3: ç¨‹åºå‘˜éƒ½ä¼šé‡åˆ°çš„å­—ç¬¦é›†é—®é¢˜ğŸ˜¹

è¯´è¯´æŠ˜è…¾å†ç¨‹ï¼Œä¸€çœ¼çœ‹é”™è¯¯å¤§æ¦‚å°±æ˜¯æ•°æ®åº“å­—ç¬¦é›†ä¸å…¼å®¹ï¼Œå—¯~~~

æœæ–­å»çœ‹mysqlçš„å­—ç¬¦é›†è®¾ç½®,åº¦å¨˜äº†ä¸ªåŸºæœ¬æ¦‚å¿µï¼Œè§‰å¾—åº”è¯¥è®°å½•ä¸‹æ¥æ‹·è´å¦‚ä¸‹ï¼š

----



> **åŸºæœ¬æ¦‚å¿µ**

- å­—ç¬¦(Character)æ˜¯æŒ‡äººç±»è¯­è¨€ä¸­æœ€å°çš„è¡¨ä¹‰ç¬¦å·ã€‚ä¾‹å¦‚â€™A'ã€â€™B'ç­‰ï¼›
- ç»™å®šä¸€ç³»åˆ—å­—ç¬¦ï¼Œå¯¹æ¯ä¸ªå­—ç¬¦èµ‹äºˆä¸€ä¸ªæ•°å€¼ï¼Œç”¨æ•°å€¼æ¥ä»£è¡¨å¯¹åº”çš„å­—ç¬¦ï¼Œè¿™ä¸€æ•°å€¼å°±æ˜¯å­—ç¬¦çš„ç¼–ç (Encoding)ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ç»™å­—ç¬¦â€™A'èµ‹äºˆæ•°å€¼0ï¼Œç»™å­—ç¬¦â€™B'èµ‹äºˆæ•°å€¼1ï¼Œåˆ™0å°±æ˜¯å­—ç¬¦â€™A'çš„ç¼–ç ï¼›
- ç»™å®šä¸€ç³»åˆ—å­—ç¬¦å¹¶èµ‹äºˆå¯¹åº”çš„ç¼–ç åï¼Œæ‰€æœ‰è¿™äº›å­—ç¬¦å’Œç¼–ç å¯¹ç»„æˆçš„é›†åˆå°±æ˜¯å­—ç¬¦é›†(Character Set)ã€‚ä¾‹å¦‚ï¼Œç»™å®šå­—ç¬¦åˆ—è¡¨ä¸º{â€™A',â€™B'}æ—¶ï¼Œ{â€™A'=>0, â€˜Bâ€™=>1}å°±æ˜¯ä¸€ä¸ªå­—ç¬¦é›†ï¼›
- å­—ç¬¦åº(Collation)æ˜¯æŒ‡åœ¨åŒä¸€å­—ç¬¦é›†å†…å­—ç¬¦ä¹‹é—´çš„æ¯”è¾ƒè§„åˆ™ï¼›
- ç¡®å®šå­—ç¬¦åºåï¼Œæ‰èƒ½åœ¨ä¸€ä¸ªå­—ç¬¦é›†ä¸Šå®šä¹‰ä»€ä¹ˆæ˜¯ç­‰ä»·çš„å­—ç¬¦ï¼Œä»¥åŠå­—ç¬¦ä¹‹é—´çš„å¤§å°å…³ç³»ï¼›
- æ¯ä¸ªå­—ç¬¦åºå”¯ä¸€å¯¹åº”ä¸€ç§å­—ç¬¦é›†ï¼Œä½†ä¸€ä¸ªå­—ç¬¦é›†å¯ä»¥å¯¹åº”å¤šç§å­—ç¬¦åºï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯é»˜è®¤å­—ç¬¦åº(Default Collation)ï¼›
- MySQLä¸­çš„å­—ç¬¦åºåç§°éµä»å‘½åæƒ¯ä¾‹ï¼šä»¥å­—ç¬¦åºå¯¹åº”çš„å­—ç¬¦é›†åç§°å¼€å¤´ï¼›ä»¥_ci(è¡¨ç¤ºå¤§å°å†™ä¸æ•æ„Ÿ)ã€_cs(è¡¨ç¤ºå¤§å°å†™æ•æ„Ÿ)æˆ–_bin(è¡¨ç¤ºæŒ‰ç¼–ç å€¼æ¯”è¾ƒ)ç»“å°¾ã€‚ä¾‹å¦‚ï¼šåœ¨å­—ç¬¦åºâ€œutf8_general_ciâ€ä¸‹ï¼Œå­—ç¬¦â€œaâ€å’Œâ€œAâ€æ˜¯ç­‰ä»·çš„ï¼›

> **MySQLå­—ç¬¦é›†è®¾ç½®**

â€¢ ç³»ç»Ÿå˜é‡ï¼š
â€“ character_set_serverï¼šé»˜è®¤çš„å†…éƒ¨æ“ä½œå­—ç¬¦é›†
â€“ character_set_clientï¼šå®¢æˆ·ç«¯æ¥æºæ•°æ®ä½¿ç”¨çš„å­—ç¬¦é›†
â€“ character_set_connectionï¼šè¿æ¥å±‚å­—ç¬¦é›†
â€“ character_set_resultsï¼šæŸ¥è¯¢ç»“æœå­—ç¬¦é›†
â€“ character_set_databaseï¼šå½“å‰é€‰ä¸­æ•°æ®åº“çš„é»˜è®¤å­—ç¬¦é›†
â€“ character_set_systemï¼šç³»ç»Ÿå…ƒæ•°æ®(å­—æ®µåç­‰)å­—ç¬¦é›†
â€“ è¿˜æœ‰ä»¥collation_å¼€å¤´çš„åŒä¸Šé¢å¯¹åº”çš„å˜é‡ï¼Œç”¨æ¥æè¿°å­—ç¬¦åºã€‚

â€¢ ç”¨introduceræŒ‡å®šæ–‡æœ¬å­—ç¬¦ä¸²çš„å­—ç¬¦é›†ï¼š
â€“ æ ¼å¼ä¸ºï¼š[_charset] â€™stringâ€™ [COLLATE collation]
â€“ ä¾‹å¦‚ï¼š
       SELECT _latin1 â€™stringâ€™;
       SELECT _utf8 â€˜ä½ å¥½â€™ COLLATE utf8_general_ci;
â€“ ç”±introducerä¿®é¥°çš„æ–‡æœ¬å­—ç¬¦ä¸²åœ¨è¯·æ±‚è¿‡ç¨‹ä¸­ä¸ç»è¿‡å¤šä½™çš„è½¬ç ï¼Œç›´æ¥è½¬æ¢ä¸ºå†…éƒ¨å­—ç¬¦é›†å¤„ç†ã€‚

> **MySQLä¸­çš„å­—ç¬¦é›†è½¬æ¢è¿‡ç¨‹**

1. MySQL Serveræ”¶åˆ°è¯·æ±‚æ—¶å°†è¯·æ±‚æ•°æ®ä»character_set_clientè½¬æ¢ä¸ºcharacter_set_connectionï¼›
2. è¿›è¡Œå†…éƒ¨æ“ä½œå‰å°†è¯·æ±‚æ•°æ®ä»character_set_connectionè½¬æ¢ä¸ºå†…éƒ¨æ“ä½œå­—ç¬¦é›†ï¼Œå…¶ç¡®å®šæ–¹æ³•å¦‚ä¸‹ï¼š

â€‹       - ä½¿ç”¨æ¯ä¸ªæ•°æ®å­—æ®µçš„CHARACTER SETè®¾å®šå€¼ï¼›
       - è‹¥ä¸Šè¿°å€¼ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨å¯¹åº”æ•°æ®è¡¨çš„DEFAULT CHARACTER SETè®¾å®šå€¼(MySQLæ‰©å±•ï¼ŒéSQLæ ‡å‡†)ï¼›
       - è‹¥ä¸Šè¿°å€¼ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨å¯¹åº”æ•°æ®åº“çš„DEFAULT CHARACTER SETè®¾å®šå€¼ï¼›
       - è‹¥ä¸Šè¿°å€¼ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨character_set_serverè®¾å®šå€¼ã€‚

3. å°†æ“ä½œç»“æœä»å†…éƒ¨æ“ä½œå­—ç¬¦é›†è½¬æ¢ä¸ºcharacter_set_resultsã€‚

  æˆ‘ä»¬ç°åœ¨å›è¿‡å¤´æ¥åˆ†æä¸‹æˆ‘ä»¬äº§ç”Ÿçš„ä¹±ç é—®é¢˜ï¼š
          a æˆ‘ä»¬çš„å­—æ®µæ²¡æœ‰è®¾ç½®å­—ç¬¦é›†ï¼Œå› æ­¤ä½¿ç”¨è¡¨çš„æ•°æ®é›†
          b æˆ‘ä»¬çš„è¡¨æ²¡æœ‰æŒ‡å®šå­—ç¬¦é›†ï¼Œé»˜è®¤ä½¿ç”¨æ•°æ®åº“å­˜çš„å­—ç¬¦é›†
          c æˆ‘ä»¬çš„æ•°æ®åº“åœ¨åˆ›å»ºçš„æ—¶å€™æ²¡æœ‰æŒ‡å®šå­—ç¬¦é›†ï¼Œå› æ­¤ä½¿ç”¨character_set_serverè®¾å®šå€¼
          d æˆ‘ä»¬æ²¡æœ‰ç‰¹æ„å»ä¿®æ”¹character_set_serverçš„æŒ‡å®šå­—ç¬¦é›†ï¼Œå› æ­¤ä½¿ç”¨mysqlé»˜è®¤
          e mysqlé»˜è®¤çš„å­—ç¬¦é›†æ˜¯latin1ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†latin1å­—ç¬¦é›†ï¼Œè€Œæˆ‘ä»¬character_set_connectionçš„å­—ç¬¦é›†æ˜¯UTF-8ï¼Œæ’å…¥ä¸­æ–‡ä¹±ç ä¹Ÿå†æ‰€éš¾å…äº†ã€‚

**å¸¸è§é—®é¢˜è§£æ**

- FAQ-1 å‘é»˜è®¤å­—ç¬¦é›†ä¸ºutf8çš„æ•°æ®è¡¨æ’å…¥utf8ç¼–ç çš„æ•°æ®å‰æ²¡æœ‰è®¾ç½®è¿æ¥å­—ç¬¦é›†ï¼ŒæŸ¥è¯¢æ—¶è®¾ç½®è¿æ¥å­—ç¬¦é›†ä¸ºutf8

â€‹     â€“ æ’å…¥æ—¶æ ¹æ®MySQLæœåŠ¡å™¨çš„é»˜è®¤è®¾ç½®ï¼Œcharacter_set_clientã€character_set_connectionå’Œcharacter_set_resultså‡ä¸ºlatin1ï¼›
     â€“ æ’å…¥æ“ä½œçš„æ•°æ®å°†ç»è¿‡latin1=>latin1=>utf8çš„å­—ç¬¦é›†è½¬æ¢è¿‡ç¨‹ï¼Œè¿™ä¸€è¿‡ç¨‹ä¸­æ¯ä¸ªæ’å…¥çš„æ±‰å­—éƒ½ä¼šä»åŸå§‹çš„3ä¸ªå­—èŠ‚å˜æˆ6ä¸ªå­—èŠ‚ä¿å­˜ï¼›
     â€“ æŸ¥è¯¢æ—¶çš„ç»“æœå°†ç»è¿‡utf8=>utf8çš„å­—ç¬¦é›†è½¬æ¢è¿‡ç¨‹ï¼Œå°†ä¿å­˜çš„6ä¸ªå­—èŠ‚åŸå°ä¸åŠ¨è¿”å›ï¼Œäº§ç”Ÿä¹±ç ã€‚

- å‘é»˜è®¤å­—ç¬¦é›†ä¸ºlatin1çš„æ•°æ®è¡¨æ’å…¥utf8ç¼–ç çš„æ•°æ®å‰è®¾ç½®äº†è¿æ¥å­—ç¬¦é›†ä¸ºutf8ï¼ˆ**é‡åˆ°çš„é”™è¯¯å¤§æ¦‚å°±æ˜¯å±äºè¿™ä¸€ç§**ï¼‰

â€‹     â€“ æ’å…¥æ—¶æ ¹æ®è¿æ¥å­—ç¬¦é›†è®¾ç½®ï¼Œcharacter_set_clientã€character_set_connectionå’Œcharacter_set_resultså‡ä¸ºutf8ï¼›
     â€“ æ’å…¥æ•°æ®å°†ç»è¿‡utf8=>utf8=>latin1çš„å­—ç¬¦é›†è½¬æ¢ï¼Œè‹¥åŸå§‹æ•°æ®ä¸­å«æœ‰\u0000~\u00ffèŒƒå›´ä»¥å¤–çš„Unicodeå­—ç¬¦ï¼Œä¼šå› ä¸ºæ— æ³•åœ¨latin1å­—ç¬¦é›†ä¸­è¡¨ç¤ºè€Œè¢«è½¬æ¢ä¸ºâ€œ?â€(0Ã—3F)ç¬¦å·ï¼Œä»¥åæŸ¥è¯¢æ—¶ä¸ç®¡è¿æ¥å­—ç¬¦é›†è®¾ç½®å¦‚ä½•éƒ½æ— æ³•æ¢å¤å…¶å†…å®¹äº†ã€‚
**æ£€æµ‹å­—ç¬¦é›†é—®é¢˜çš„ä¸€äº›æ‰‹æ®µ**
    â€¢ SHOW CHARACTER SET;
    â€¢ SHOW COLLATION;
    â€¢ SHOW VARIABLES LIKE â€˜character%â€™;
    â€¢ SHOW VARIABLES LIKE â€˜collation%â€™;
    â€¢ SQLå‡½æ•°HEXã€LENGTHã€CHAR_LENGTH
    â€¢ SQLå‡½æ•°CHARSETã€COLLATION
**ä½¿ç”¨MySQLå­—ç¬¦é›†æ—¶çš„å»ºè®®**
    â€¢ å»ºç«‹æ•°æ®åº“/è¡¨å’Œè¿›è¡Œæ•°æ®åº“æ“ä½œæ—¶å°½é‡æ˜¾å¼æŒ‡å‡ºä½¿ç”¨çš„å­—ç¬¦é›†ï¼Œè€Œä¸æ˜¯ä¾èµ–äºMySQLçš„é»˜è®¤è®¾ç½®ï¼Œå¦åˆ™MySQLå‡çº§æ—¶å¯èƒ½å¸¦æ¥å¾ˆå¤§å›°æ‰°ï¼›
    â€¢ æ•°æ®åº“å’Œè¿æ¥å­—ç¬¦é›†éƒ½ä½¿ç”¨latin1æ—¶ï¼Œè™½ç„¶å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½å¯ä»¥è§£å†³ä¹±ç é—®é¢˜ï¼Œä½†ç¼ºç‚¹æ˜¯æ— æ³•ä»¥å­—ç¬¦ä¸ºå•ä½æ¥è¿›è¡ŒSQLæ“ä½œï¼Œä¸€èˆ¬æƒ…å†µä¸‹å°†æ•°æ®åº“å’Œè¿æ¥å­—ç¬¦é›†éƒ½ç½®ä¸ºutf8æ˜¯è¾ƒå¥½çš„é€‰æ‹©ï¼›
    â€¢ ä½¿ç”¨mysql CAPIï¼ˆmysqlæä¾›Cè¯­è¨€æ“ä½œçš„APIï¼‰æ—¶ï¼Œåˆå§‹åŒ–æ•°æ®åº“å¥æŸ„åé©¬ä¸Šç”¨mysql_optionsè®¾å®šMYSQL_SET_CHARSET_NAMEå±æ€§ä¸ºutf8ï¼Œè¿™æ ·å°±ä¸ç”¨æ˜¾å¼åœ°ç”¨SET NAMESè¯­å¥æŒ‡å®šè¿æ¥å­—ç¬¦é›†ï¼Œä¸”ç”¨mysql_pingé‡è¿æ–­å¼€çš„é•¿è¿æ¥æ—¶ä¹Ÿä¼šæŠŠè¿æ¥å­—ç¬¦é›†é‡ç½®ä¸ºutf8ï¼›
    â€¢ å¯¹äºmysql PHP APIï¼Œä¸€èˆ¬é¡µé¢çº§çš„PHPç¨‹åºæ€»è¿è¡Œæ—¶é—´è¾ƒçŸ­ï¼Œåœ¨è¿æ¥åˆ°æ•°æ®åº“ä»¥åæ˜¾å¼ç”¨SET NAMESè¯­å¥è®¾ç½®ä¸€æ¬¡è¿æ¥å­—ç¬¦é›†å³å¯ï¼›ä½†å½“ä½¿ç”¨é•¿è¿æ¥æ—¶ï¼Œè¯·æ³¨æ„ä¿æŒè¿æ¥é€šç•…å¹¶åœ¨æ–­å¼€é‡è¿åç”¨SET NAMESè¯­å¥æ˜¾å¼é‡ç½®è¿æ¥å­—ç¬¦é›†ã€‚
**å…¶ä»–æ³¨æ„äº‹é¡¹**
    â€¢ my.cnfä¸­çš„default_character_setè®¾ç½®åªå½±å“mysqlå‘½ä»¤è¿æ¥æœåŠ¡å™¨æ—¶çš„è¿æ¥å­—ç¬¦é›†ï¼Œä¸ä¼šå¯¹ä½¿ç”¨libmysqlclientåº“çš„åº”ç”¨ç¨‹åºäº§ç”Ÿä»»ä½•ä½œç”¨ï¼
    â€¢ å¯¹å­—æ®µè¿›è¡Œçš„SQLå‡½æ•°æ“ä½œé€šå¸¸éƒ½æ˜¯ä»¥å†…éƒ¨æ“ä½œå­—ç¬¦é›†è¿›è¡Œçš„ï¼Œä¸å—è¿æ¥å­—ç¬¦é›†è®¾ç½®çš„å½±å“ã€‚
    â€¢ SQLè¯­å¥ä¸­çš„è£¸å­—ç¬¦ä¸²ä¼šå—åˆ°è¿æ¥å­—ç¬¦é›†æˆ–introducerè®¾ç½®çš„å½±å“ï¼Œå¯¹äºæ¯”è¾ƒä¹‹ç±»çš„æ“ä½œå¯èƒ½äº§ç”Ÿå®Œå…¨ä¸åŒçš„ç»“æœï¼Œéœ€è¦å°å¿ƒï¼
**æ€»ç»“**
    æ ¹æ®ä¸Šé¢çš„åˆ†æå’Œå»ºè®®ï¼Œæˆ‘ä»¬è§£å†³æˆ‘ä»¬é‡åˆ°é—®é¢˜åº”è¯¥ä½¿ç”¨ä»€ä¹ˆæ–¹æ³•å¤§å®¶å¿ƒé‡Œåº”è¯¥æ¯”è¾ƒæ¸…æ¥šäº†ã€‚å¯¹ï¼Œå°±æ˜¯åœ¨åˆ›å»ºdatabaseçš„æ—¶å€™æŒ‡å®šå­—ç¬¦é›†ï¼Œä¸è¦å»é€šè¿‡ä¿®æ”¹é»˜è®¤é…ç½®æ¥è¾¾åˆ°ç›®çš„ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é‡‡ç”¨æŒ‡å®šè¡¨çš„å­—ç¬¦é›†çš„å½¢å¼ï¼Œä½†å¾ˆå®¹æ˜“å‡ºç°é—æ¼ï¼Œç‰¹åˆ«æ˜¯åœ¨å¾ˆå¤šäººéƒ½å‚ä¸è®¾è®¡çš„æ—¶å€™ï¼Œæ›´å®¹æ˜“çº°æ¼ã€‚
    è™½ç„¶ä¸æå€¡é€šè¿‡ä¿®æ”¹mysqlçš„é»˜è®¤å­—ç¬¦é›†æ¥è§£å†³ï¼Œä½†å¯¹äºå¦‚ä½•å»ä¿®æ”¹é»˜è®¤å­—ç¬¦é›†ï¼Œæˆ‘è¿™é‡Œè¿˜æ˜¯ç»™å‡ºä¸€äº›æ–¹æ³•ï¼Œä»…ä¾›å¤§å®¶å‚è€ƒã€‚
**MySQLé»˜è®¤å­—ç¬¦é›†**
MySQLå¯¹äºå­—ç¬¦é›†çš„æŒ‡å®šå¯ä»¥ç»†åŒ–åˆ°ä¸€ä¸ªæ•°æ®åº“ï¼Œä¸€å¼ è¡¨ï¼Œä¸€åˆ—.ä¼ ç»Ÿçš„ç¨‹åºåœ¨åˆ›å»ºæ•°æ®åº“å’Œæ•°æ®è¡¨æ—¶å¹¶æ²¡æœ‰ä½¿ç”¨é‚£ä¹ˆå¤æ‚çš„é…ç½®ï¼Œå®ƒä»¬ç”¨çš„æ˜¯é»˜è®¤çš„é…ç½®.
    (1)ç¼–è¯‘MySQL æ—¶ï¼ŒæŒ‡å®šäº†ä¸€ä¸ªé»˜è®¤çš„å­—ç¬¦é›†ï¼Œè¿™ä¸ªå­—ç¬¦é›†æ˜¯ latin1ï¼›
    (2)å®‰è£…MySQL æ—¶ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ (my.ini) ä¸­æŒ‡å®šä¸€ä¸ªé»˜è®¤çš„çš„å­—ç¬¦é›†ï¼Œå¦‚æœæ²¡æŒ‡å®šï¼Œè¿™ä¸ªå€¼ç»§æ‰¿è‡ªç¼–è¯‘æ—¶æŒ‡å®šçš„ï¼›
    (3)å¯åŠ¨mysqld æ—¶ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œå‚æ•°ä¸­æŒ‡å®šä¸€ä¸ªé»˜è®¤çš„çš„å­—ç¬¦é›†ï¼Œå¦‚æœæ²¡æŒ‡å®šï¼Œè¿™ä¸ªå€¼ç»§æ‰¿è‡ªé…ç½®æ–‡ä»¶ä¸­çš„é…ç½®,æ­¤æ—¶ character_set_server è¢«è®¾å®šä¸ºè¿™ä¸ªé»˜è®¤çš„å­—ç¬¦é›†ï¼›
    (4)å®‰è£… MySQLé€‰æ‹©å¤šè¯­è¨€æ”¯æŒï¼Œå®‰è£…ç¨‹åºä¼šè‡ªåŠ¨åœ¨é…ç½®æ–‡ä»¶ä¸­æŠŠdefault_character_set è®¾ç½®ä¸º UTF-8ï¼Œä¿è¯ç¼ºçœæƒ…å†µä¸‹æ‰€æœ‰çš„æ•°æ®åº“æ‰€æœ‰è¡¨çš„æ‰€æœ‰åˆ—çš„éƒ½ç”¨ UTF-8 å­˜å‚¨ã€‚
**æŸ¥çœ‹é»˜è®¤å­—ç¬¦é›†**
    (é»˜è®¤æƒ…å†µä¸‹ï¼Œmysqlçš„å­—ç¬¦é›†æ˜¯latin1(ISO_8859_1)ï¼Œå¦‚ä½•æŸ¥çœ‹åœ¨ä¸Šé¢æˆ‘ä»¬å·²ç»ç»™å‡ºäº†ç›¸å…³å‘½ä»¤
**ä¿®æ”¹é»˜è®¤å­—ç¬¦é›†**
(1) æœ€ç®€å•çš„ä¿®æ”¹æ–¹æ³•ï¼Œå°±æ˜¯ä¿®æ”¹mysqlçš„my.iniæ–‡ä»¶ä¸­çš„å­—ç¬¦é›†é”®å€¼ï¼Œ
     å¦‚    default-character-set = utf8
      character_set_server =  utf8
     ä¿®æ”¹å®Œåï¼Œé‡å¯mysqlçš„æœåŠ¡
(2) è¿˜æœ‰ä¸€ç§ä¿®æ”¹å­—ç¬¦é›†çš„æ–¹æ³•ï¼Œå°±æ˜¯ä½¿ç”¨mysqlçš„å‘½ä»¤
     mysql> SET character_set_client = utf8 ;
     mysql> SET character_set_connection = utf8 ;
     mysql> SET character_set_database = utf8 ;
     mysql> SET character_set_results = utf8 ;
     mysql> SET character_set_server = utf8 ;
     mysql> SET collation_connection = utf8 ;
     mysql> SET collation_database = utf8 ;
     mysql> SET collation_server = utf8 ;
    è®¾ç½®äº†è¡¨çš„é»˜è®¤å­—ç¬¦é›†ä¸ºutf8å¹¶ä¸”é€šè¿‡UTF-8ç¼–ç å‘é€æŸ¥è¯¢ï¼Œå­˜å…¥æ•°æ®åº“çš„ä»ç„¶æ˜¯ä¹±ç ã€‚é‚£connectionè¿æ¥å±‚ä¸Šå¯èƒ½å‡ºäº†é—®é¢˜ã€‚è§£å†³æ–¹æ³•æ˜¯åœ¨å‘é€æŸ¥è¯¢å‰æ‰§è¡Œä¸€ä¸‹ä¸‹é¢è¿™å¥ï¼š SET NAMES 'utf8';å®ƒç›¸å½“äºä¸‹é¢çš„ä¸‰å¥æŒ‡ä»¤ï¼š
SET character_set_client = utf8;
SET character_set_results = utf8;
SET character_set_connection = utf8;

## A3 go onï¼š **å›åˆ°æ­£é¢˜**

å»æ•°æ®åº“çœ‹äº†ä¸€çœ¼ï¼Œæœç„¶å­—ç¬¦é›†æ˜¯ latin1ï¼›æƒ³æƒ³åŠæ³•ï¼Œé•œåƒé‡Œé¢ç›´æ¥æ”¹é…ç½®ï¼Ÿmysqlç»ˆç«¯ç›´æ¥setï¼Ÿå—¯~~~è¯•è¿‡äº†ï¼Œéƒ½ä¸è¡Œï¼ŒåŸå› å¾ˆç®€å•ï¼Œå‰é¢çš„å‘ï¼Œmysqlçš„é…ç½®æ²¡åšvolumeé…ç½®ï¼Œæ¶å¿ƒäº† ï¼Œåªè¦é‡æ–°å¯åŠ¨å®¹å™¨å°±éƒ½ä¸è¡Œäº†ã€‚



å¥½å§ï¼Œå°è¯•ä¿®æ”¹composeæ–‡ä»¶ æ·»åŠ mysqlé…ç½®volume é‡æ–°ç”Ÿæˆå®¹å™¨ï¼Œæƒ³ç€åº”è¯¥æ²¡å•¥ï¼Œ

```shell
# vim docker-compose.yml  //æ·»åŠ #2#é…ç½® 

# docker stop gogsdbï¼›
# docker rm gogsdb;  //ä¸åˆ é™¤db_dataçš„volume ä¿æŒåŸæœ‰æ•°æ®ä¸ä¸¢å¤±
# docker-compose up -d 
```

```mysql
#é™„ä¸Šé…ç½®ä¿®æ”¹é¡¹ /Users/lele/docker_project/mysql/conf.d/docker.cnf
[client]
default-character-set=utf8mb4


[mysqld]
skip-host-cache
skip-name-resolve


character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci
init-connect='SET NAMES utf8mb4;'
```

æµ‹è¯•ï¼Œè¿˜æ˜¯æŠ¥é”™ï¼Œå—¯Â·Â·Â·Â·Â·Â· æ¢ç§ä¿®æ”¹æ€è·¯ 

```shell
# vim docker-compose.yml  //æ·»åŠ #1#é…ç½® 
# docker-compose up -d
Recreating gogsdb ... done
Recreating gogsapp ... done
```

æµ‹è¯•ï¼Œè¿˜æ˜¯æŠ¥é”™ï¼Œå—¯.....çœ‹æ¥æƒ³ä¿å­˜å†å²æ•°æ®è¡Œä¸é€šäº†.....ç»§ç»­æŠ˜è…¾

```shell
//æŸ¥è¯¢è¯¥å‘½ä»¤ åˆ é™¤å®¹å™¨ã€åˆ é™¤volume è¿™ä¸‹æ¸…å‡€äº†
#docker-compose down
#docker-compose up -d
```

æµ‹è¯•ï¼Œä¸€ä¸‹å›åˆ°è§£æ”¾å‰æ³¨å†Œç”¨æˆ·å…¨æ²¡äº†ã€‚ã€‚ã€‚ä½†æ˜¯å­—ç¬¦é›†é—®é¢˜æå®šäº†ï¼Œåæ€æ€ä¹ˆæ ·èƒ½ä¿å­˜åŸæ¥çš„æ•°æ®å‘¢ï¼Ÿçº¿ä¸Šä½¿ç”¨çš„gogså¯ä¸èƒ½è¿™ä¹ˆæ•´å“ˆã€‚

å—¯ï¼Œå¤‡ä»½æ•°æ®åº“**mysqldump**å¤‡ä»½

```mysql
#docker exec -it gogsdb /bin/bash
#mysqldump gogs -uroot -p > gogs.sql
//å·ç„ä¸€ä¸‹
#cat gogs.sql
-- MySQL dump 10.13  Distrib 5.7.21, for Linux (x86_64)
--
-- Host: localhost    Database: gogs
-- ------------------------------------------------------
-- Server version	5.7.21

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Table structure for table `access`
--

DROP TABLE IF EXISTS `access`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `access` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `user_id` bigint(20) DEFAULT NULL,
  `repo_id` bigint(20) DEFAULT NULL,
  `mode` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `UQE_access_s` (`user_id`,`repo_id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC;
/*!40101 SET character_set_client = @saved_cs_client */;
```

**å—¯ï¼Œæ‰¾åˆ°é—®é¢˜æ ¹ï¼Œgogsåˆå§‹åŒ–åº“è¡¨å·²ç»è®¾ç½®å¥½äº†æ¯ä¸ªè¡¨çš„CHARSETï¼Œæ‰€ä»¥ä¸é‡æ–°å»ºæ˜¯æä¸å®šçš„äº†**

å¥½å§ï¼Œé‚£çœ‹æ¥è¿ç§»å†å²æ•°æ®åªæœ‰ä¸€ä¸ªåŠæ³•äº†ï¼Œ**åªå¤‡ä»½mysqlæ•°æ®ä¸å¤‡ä»½è¡¨ç»“æ„**ï¼Œé‡æ–°å½»åº•ç”Ÿæˆå®¹å™¨æ¢å¤ 

```shell
#docker exec -it gogsdb /bin/bash
#mysqldump -t gogs -uroot -p > gogs_data.sql
#exit
#docker cp gogsdb:/gogs_data.sql .
#docker-compose down
#docker-compose up -d
#docker cp gogs_data.sql gogsdb:/gogs_data.sql 
#docker exec -it gogsdb /bin/bash
#mysql -uroot -p
mysql> use gogs;
mysql> source gogs_data.sql
```

è¿™ä¸ªåªåœ¨æœ¬æœºæµ‹è¯•é€šè¿‡ï¼Œç†è®ºå¯è¡Œã€‚ä¸‹é¢è‡ªå·±å†³å®šæ‹¿ä¸ªåœ¨çº¿åº“ç©ä¸€ç¥¨



## Q4: ç¦»çº¿ç¯å¢ƒå¦‚ä½•è¿ç§»å¤‡ä»½ï¼Ÿ

## A4ï¼šæœ‰äº†ä¸Šé¢çš„ç»éªŒå°±ç®€å•å¤šäº†

1. åœ¨åŸæœåŠ¡å™¨ docker dump æœ€æ–°çš„é•œåƒ   mysql  gogs
2. åœ¨åŸæœåŠ¡å™¨å¤‡ä»½ docker-compose.yml (å¼€æ”¾#1 #2 )ã€mysql dump gogsæ•°æ®åº“æ–‡ä»¶ ã€å¤‡ä»½gogs-repositoriesæ•°æ®ç›®å½•å’Œé…ç½®æ–‡ä»¶ app.ini
3. åœ¨æ–°æœåŠ¡å™¨ docker load mysql gogsé•œåƒ
4. docker-compose up -d
5. å»mysqlå®¹å™¨æ¢å¤gogsæ•°æ®åº“ï¼Œå»gogsappå®¹å™¨æ¢å¤ä»“åº“æ•°æ®æ–‡ä»¶å’Œé…ç½®app.ini
6. docker-compose restart ä¸€åˆ‡å¦‚åˆã€‚

# æ€»ç»“

dockerçš„ä¼˜åŠ¿åœ¨äºå°è£…ç¯å¢ƒï¼ŒæŠ›å¼ƒæœåŠ¡å™¨ç¯å¢ƒä¾èµ–ï¼Œä½†æ˜¯å¯å˜æ•°æ®é›†volumeæ€ä¹ˆé…ç½®ï¼Œç½‘ç»œé…ç½®ä¹Ÿå¸¦æ¥äº†ä¸€å®šçš„å¤æ‚åº¦ã€‚å­—ç¬¦é›†æ˜¯å¤§å®¶éƒ½ç»•ä¸è¿‡å»çš„å‘âŒã€‚

ç»´æŠ¤ä¸æ˜“ ä¸”è¡Œä¸”è®°å½•ã€‚

